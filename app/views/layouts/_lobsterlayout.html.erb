<div id="wrapper">
  <div id="local-header">
    <div id="headerleft">
      <a id="l_holder" style="background-color: #<%= sprintf("%02x%02x%02x",
      [ 255, (@traffic * 7).floor + 50.0 ].min, 0, 0) %>;" href="/"
      title="<%= Rails.application.name %> (<%= @traffic.to_i %>)"></a>

      <% links = {
        "/" => "Home",
        "/newest" => "Newest",
        "/comments" => "Comments"
      } %>

      <% if @user %>
        <% links.merge!({ "/threads" => "Your Threads",
          "/stories/new" => "Submit Story" }) %>
      <% end %>

      <% links.merge!({ "/search" => "Search" }) %>

      <% if @cur_url.present? && !links.keys.include?(@cur_url) &&
      @heading.present? %>
        <span id="headertitle">
          <a href="<%= @cur_url %>"><%= @heading %></a>
        </span>
      <% end %>

      <span class="headerlinks">
        <% links.each do |u,v| %>
          <a href="<%= u %>" <%= u == @cur_url ? raw("class=\"cur_url\"") :
            "" %>><%= v %></a>
        <% end %>
      </span>
    </div>

    <div id="headerright" class="<%= @user ? "loggedin" : "" %>">
      <span class="headerlinks">
      <a href="/filters" <%= @cur_url == "/filters" ?
        raw("class=\"cur_url\"") : "" %>>Filters</a>
      <% if @user %>
        <% if (count = @user.unread_message_count) > 0 %>
          <a href="/messages" class="new_messages <%= @cur_url == "/messages" ?
            "cur_url" : "" %>"><%= count %> New Message<%= count == 1 ? "" :
            "s" %></a>
        <% else %>
          <a href="/messages" <%= @cur_url == "/messages" ?
            raw("class=\"cur_url\"") : "" %>>Messages</a>
        <% end %>

        <a href="/settings" <%= @cur_url == "/settings" ?
          raw("class=\"cur_url\"") : "" %>><%= @user.username %>
          (<%= @user.karma %>)</a>

        <%= link_to "Logout", { :controller => "login", :action => "logout" },
          :data => { :confirm => "Are you sure you want to logout?" },
          :method => "post" %>
      <% else %>
        <a href="/login">Login</a>
      <% end %>
      </span>
    </div>

    <div class="clear"></div>
  </div>

  <div id="inside">
    <% if flash[:error] %>
      <div class="flash-error"><%= flash[:error] %></div>
    <% elsif flash[:success] %>
      <div class="flash-success"><%= flash[:success] %></div>
    <% end %>

    <%= yield %>

    <div id="local-footer">
      <a href="/moderations">Moderation Log</a>
      <% if @user && !@user.is_new? &&
      (iqc = InvitationRequest.verified_count) > 0 %>
        <a href="/invitations">Invitation Queue (<%= iqc %>)</a>
      <% end %>
      <a href="/privacy">Privacy</a>
      <a href="/about">About</a>
    </div>
    <div class="clear"></div>
  </div>
</div>
